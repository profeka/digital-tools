<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repositorio de R√∫bricas (Cloud)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo Neubrutalista */
        body { font-family: 'Inter', sans-serif; background-color: #f0f0f0; }
        .neubrutalist {
            background-color: #ffffff;
            border: 3px solid #000000;
            box-shadow: 6px 6px 0 #000000;
            border-radius: 8px;
        }
        .neubrutalist-button {
            background-color: #ffffff;
            border: 3px solid #000000;
            border-radius: 8px;
            font-weight: 600;
            padding: 10px 16px;
            transition: all 0.2s ease;
            box-shadow: 4px 4px 0 #000000;
            cursor: pointer;
        }
        .neubrutalist-button:hover {
            box-shadow: 2px 2px 0 #000000;
            transform: translate(2px, 2px);
        }
        .neubrutalist-button:active {
            box-shadow: 0 0 0 #000000;
            transform: translate(4px, 4px);
        }
        /* Modal */
        .modal {
            display: none; position: fixed; z-index: 50;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6);
            align-items: center; justify-content: center;
        }
        .header-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .input-constr {
            border: 2px solid #000; border-radius: 6px; padding: 8px 12px;
            font-size: 1rem; box-shadow: 3px 3px 0 #000; transition: all 0.2s ease;
        }
        .input-constr:focus { outline: none; box-shadow: 1px 1px 0 #000; transform: translate(2px, 2px); }
        .tag-constr {
            display: inline-flex; align-items: center; background-color: #e0e0e0;
            border: 2px solid #000; border-radius: 6px; padding: 4px 8px;
            font-weight: 600; box-shadow: 2px 2px 0 #000;
        }
        .tag-constr button { margin-left: 8px; font-weight: bold; color: #ef4444; }
        .tag-constr button:hover { color: #000; }
        /* Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #000; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Cabecera Fija -->
    <header class="fixed top-0 left-0 right-0 bg-white border-b-2 border-black p-3 z-50 header-shadow flex justify-between items-center">
        <div class="flex gap-2">
            <a href="calif.html" id="repo-link-btn" class="neubrutalist-button bg-blue-300 hover:bg-blue-400 !py-2 !px-3 text-sm sm:text-base">
                &larr; Volver a Herramienta
            </a>
        </div>
        <div id="header-main-title" class="flex-grow text-center">
            <h1 class="text-lg sm:text-xl font-bold truncate">Editor de R√∫bricas (Cloud)</h1>
        </div>
        <div class="w-36 flex justify-end items-center px-2">
            <div id="auth-status" class="text-xs font-mono bg-gray-100 border border-black p-1 rounded hidden">Conectado</div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto space-y-8 mt-24">
        
        <!-- Constructor -->
        <section class="neubrutalist p-5 relative">
            <!-- Indicador de modo edici√≥n -->
            <div id="editing-indicator" class="hidden absolute -top-4 left-5 bg-yellow-300 border-2 border-black px-3 py-1 font-bold shadow-md transform -rotate-2">
                ‚úèÔ∏è Editando R√∫brica Existente
            </div>

            <div class="flex justify-between items-center border-b-2 border-black pb-2 mb-4">
                <h2 class="text-3xl font-bold">Constructor</h2>
                <button id="toggle-constructor" class="neubrutalist-button !py-1 !px-3 text-sm bg-gray-200 hover:bg-gray-300">
                    Mostrar ‚ñº
                </button>
            </div>
            
            <div id="constructor-content" style="display: none;">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Columna 1: Entradas -->
                    <div class="space-y-6">
                        <div class="space-y-2">
                            <label for="c-title" class="text-lg font-bold">1. T√≠tulo de la R√∫brica</label>
                            <input type="text" id="c-title" class="input-constr w-full" placeholder="Ej: Test de Ciberseguridad">
                        </div>

                        <label class="text-lg font-bold">2. Criterios (CE) y Colores</label>
                        <div class="flex gap-2">
                            <input type="text" id="c-ce-id" class="input-constr w-1/3" placeholder="CE 3.3">
                            <input type="text" id="c-ce-title" class="input-constr w-1/3" placeholder="Identificar...">
                            <input type="text" id="c-ce-color" class="input-constr w-1/3" placeholder="red">
                            <button id="c-ce-add" class="neubrutalist-button !p-2 !shadow-sm !border-2">+</button>
                        </div>
                        <div id="c-ce-list" class="flex flex-wrap gap-2 pt-2"></div>

                        <div class="space-y-2 mt-4">
                            <label class="text-lg font-bold">3. Secciones (Casos) y Colores</label>
                            <div class="flex gap-2">
                                <input type="text" id="c-s-id" class="input-constr w-1/3" placeholder="s1">
                                <input type="text" id="c-s-title" class="input-constr w-1/3" placeholder="Caso 1...">
                                <input type="text" id="c-s-color" class="input-constr w-1/3" placeholder="blue">
                                <button id="c-s-add" class="neubrutalist-button !p-2 !shadow-sm !border-2">+</button>
                            </div>
                            <div id="c-s-list" class="flex flex-wrap gap-2 pt-2"></div>
                        </div>

                        <!-- √çtems -->
                        <div class="space-y-4 neubrutalist p-4 !mt-8 border-2 border-black">
                            <h3 class="text-xl font-bold">4. A√±adir √çtems</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="c-i-id" class="input-constr w-full col-span-1" placeholder="ID (c1.1)">
                                <input type="number" id="c-i-points" class="input-constr w-full col-span-1" placeholder="Puntos" step="0.25">
                            </div>
                            <input type="text" id="c-i-title" class="input-constr w-full" placeholder="T√≠tulo del √çtem">
                            <input type="text" id="c-i-text" class="input-constr w-full" placeholder="Descripci√≥n (Texto de ayuda)">
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="c-i-section" class="input-constr w-full" placeholder="Secci√≥n (ID)">
                                <input type="text" id="c-i-criteria" class="input-constr w-full" placeholder="Criterios (sep por coma)">
                            </div>
                            <button id="c-i-add" class="neubrutalist-button w-full bg-blue-300 hover:bg-blue-400">A√±adir √çtem</button>
                        </div>
                    </div>
                    
                    <!-- Columna 2: Resultado y Acciones -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-bold">5. Guardar / Exportar</h3>
                        <p class="text-sm text-gray-600">El c√≥digo JSON se genera autom√°ticamente.</p>
                        <textarea id="c-output-json" class="w-full h-64 p-3 border-2 border-black rounded-lg bg-gray-100 font-mono text-sm" readonly></textarea>
                        
                        <!-- BOT√ìN FIREBASE -->
                        <button id="btn-save-cloud" class="neubrutalist-button w-full bg-purple-300 hover:bg-purple-400 flex justify-center items-center gap-2 text-lg">
                            <span>‚òÅÔ∏è Guardar en la Nube</span>
                        </button>
                        
                        <div class="flex gap-2">
                            <button id="c-copy-json" class="neubrutalist-button flex-1 bg-green-300 hover:bg-green-400">Copiar JSON</button>
                            <button id="c-reset-form" class="neubrutalist-button flex-1 bg-red-300 hover:bg-red-400">Nuevo / Limpiar</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Lista de R√∫bricas (FIREBASE) -->
        <section>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">R√∫bricas en la Nube</h2>
                <div id="loading-spinner" class="loader" style="display: none;"></div>
            </div>
            
            <!-- Contenedor din√°mico -->
            <div id="rubricas-container" class="space-y-6">
                <p class="text-gray-500 italic">Conectando con la base de datos...</p>
            </div>
        </section>

    </div>

    <!-- Modal Alertas -->
    <div id="simple-modal" class="modal" style="display: none;">
        <div id="simple-modal-overlay" class="fixed inset-0 bg-black opacity-60" style="z-index: -1;"></div>
        <div class="neubrutalist p-6 w-full max-w-sm relative bg-white">
            <p id="simple-modal-message" class="text-gray-700 text-center text-lg">Mensaje.</p>
            <button id="simple-modal-close" class="neubrutalist-button w-full mt-6 bg-blue-300 hover:bg-blue-400">OK</button>
        </div>
    </div>

    <!-- SCRIPT FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuraci√≥n proporcionada por el entorno
          // Your web app's Firebase configuration

        const firebaseConfig = {

            apiKey: "AIzaSyBQEKMlgY-8lQtG1AbaPlJqFTwJmJI-kQ4",

            authDomain: "rubric-repo.firebaseapp.com",

            projectId: "rubric-repo",

            storageBucket: "rubric-repo.firebasestorage.app",

            messagingSenderId: "500836148512",

            appId: "1:500836148512:web:da33f04b80cac2b7b22345"

            };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Variables de Estado
        let currentUser = null;
        let constructorData = { title: "", reportMap: {}, evaluationData: [] };
        let editingId = null; // Si no es null, estamos editando una r√∫brica existente

        // Referencias DOM
        const els = {
            container: document.getElementById('rubricas-container'),
            saveBtn: document.getElementById('btn-save-cloud'),
            resetBtn: document.getElementById('c-reset-form'),
            copyBtn: document.getElementById('c-copy-json'),
            output: document.getElementById('c-output-json'),
            spinner: document.getElementById('loading-spinner'),
            authStatus: document.getElementById('auth-status'),
            editingIndicator: document.getElementById('editing-indicator'),
            toggleBtn: document.getElementById('toggle-constructor'),
            constructorContent: document.getElementById('constructor-content'),
            
            // Inputs
            title: document.getElementById('c-title'),
            ceId: document.getElementById('c-ce-id'), ceTitle: document.getElementById('c-ce-title'), ceColor: document.getElementById('c-ce-color'), ceAdd: document.getElementById('c-ce-add'), ceList: document.getElementById('c-ce-list'),
            sId: document.getElementById('c-s-id'), sTitle: document.getElementById('c-s-title'), sColor: document.getElementById('c-s-color'), sAdd: document.getElementById('c-s-add'), sList: document.getElementById('c-s-list'),
            iId: document.getElementById('c-i-id'), iTitle: document.getElementById('c-i-title'), iText: document.getElementById('c-i-text'), iPoints: document.getElementById('c-i-points'), iSection: document.getElementById('c-i-section'), iCriteria: document.getElementById('c-i-criteria'), iAdd: document.getElementById('c-i-add')
        };

        // --- 1. Autenticaci√≥n ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                 await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                 await signInAnonymously(auth);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                els.authStatus.style.display = 'block';
                subscribeToRubrics();
            }
        });

        // --- 2. Funciones Auxiliares ---
        function showMessage(msg) {
            document.getElementById('simple-modal-message').innerText = msg;
            document.getElementById('simple-modal').style.display = 'flex';
        }
        document.getElementById('simple-modal-close').addEventListener('click', () => document.getElementById('simple-modal').style.display = 'none');
        document.getElementById('simple-modal-overlay').addEventListener('click', () => document.getElementById('simple-modal').style.display = 'none');

        function updateOutput() {
            if (els.title.value) constructorData.title = els.title.value;
            els.output.value = JSON.stringify(constructorData, null, 4);
        }

        function createTag(id, text, listEl, mapKey) {
            const tag = document.createElement('div');
            tag.className = 'tag-constr';
            tag.innerHTML = `<span>${text}</span>`;
            const delBtn = document.createElement('button');
            delBtn.innerText = '√ó';
            delBtn.onclick = () => {
                tag.remove();
                delete constructorData.reportMap[id];
                if (mapKey === 'isSection') {
                    constructorData.evaluationData = constructorData.evaluationData.filter(item => item.section !== id);
                }
                updateOutput();
            };
            tag.appendChild(delBtn);
            listEl.appendChild(tag);
        }

        function resetForm() {
            constructorData = { title: "", reportMap: {}, evaluationData: [] };
            editingId = null;
            els.title.value = '';
            els.ceList.innerHTML = '';
            els.sList.innerHTML = '';
            els.output.value = '';
            els.editingIndicator.classList.add('hidden');
            els.saveBtn.innerHTML = '<span>‚òÅÔ∏è Guardar en la Nube</span>';
            // Limpiar inputs peque√±os
            [els.ceId, els.ceTitle, els.ceColor, els.sId, els.sTitle, els.sColor, els.iId, els.iTitle, els.iText, els.iPoints, els.iSection, els.iCriteria].forEach(el => el.value = '');
        }

        // --- 3. L√≥gica Constructor ---
        els.ceAdd.addEventListener('click', () => {
            const id = els.ceId.value.trim();
            if (!id) return showMessage("Falta ID del criterio");
            constructorData.reportMap[id] = { title: els.ceTitle.value.trim(), color: els.ceColor.value.trim(), isSection: false };
            createTag(id, id, els.ceList, false);
            els.ceId.value = ''; els.ceTitle.value = ''; els.ceColor.value = '';
            updateOutput();
        });

        els.sAdd.addEventListener('click', () => {
            const id = els.sId.value.trim();
            if (!id) return showMessage("Falta ID de la secci√≥n");
            constructorData.reportMap[id] = { title: els.sTitle.value.trim(), color: els.sColor.value.trim(), isSection: true };
            createTag(id, id, els.sList, true);
            els.sId.value = ''; els.sTitle.value = ''; els.sColor.value = '';
            updateOutput();
        });

        els.iAdd.addEventListener('click', () => {
            const item = {
                id: els.iId.value.trim(),
                title: els.iTitle.value.trim(),
                text: els.iText.value.trim(),
                points: parseFloat(els.iPoints.value),
                section: els.iSection.value.trim(),
                criteria: els.iCriteria.value.split(',').map(s => s.trim()).filter(s => s)
            };
            if(!item.id || !item.points || !item.section) return showMessage("Faltan datos obligatorios (ID, Puntos, Secci√≥n)");
            
            // Validaciones b√°sicas
            if(!constructorData.reportMap[item.section]) return showMessage(`La secci√≥n ${item.section} no existe`);
            
            constructorData.evaluationData.push(item);
            showMessage(`√çtem ${item.id} a√±adido`);
            updateOutput();
            // Limpiar inputs √≠tem
            [els.iId, els.iTitle, els.iText, els.iPoints, els.iSection, els.iCriteria].forEach(el => el.value = '');
        });

        els.title.addEventListener('input', updateOutput);
        
        els.toggleBtn.addEventListener('click', () => {
            const isHidden = els.constructorContent.style.display === 'none';
            els.constructorContent.style.display = isHidden ? 'block' : 'none';
            els.toggleBtn.innerText = isHidden ? 'Ocultar ‚ñ≤' : 'Mostrar ‚ñº';
        });

        els.resetBtn.addEventListener('click', resetForm);
        
        els.copyBtn.addEventListener('click', () => {
            els.output.select();
            document.execCommand('copy');
            showMessage("JSON copiado");
        });

        // --- 4. Operaciones Firebase ---
        
        // GUARDAR (Create / Update)
        els.saveBtn.addEventListener('click', async () => {
            if (!currentUser) return showMessage("Esperando conexi√≥n...");
            if (!constructorData.title) return showMessage("Ponle un t√≠tulo a la r√∫brica.");

            try {
                els.saveBtn.innerHTML = '<span>‚è≥ Guardando...</span>';
                
                // Si es nuevo, generamos un ID basado en el t√≠tulo (limpio) + sufijo random
                if (!editingId) {
                    const cleanTitle = constructorData.title.toLowerCase().replace(/[^a-z0-9]/g, '_').substring(0, 20);
                    editingId = `${cleanTitle}_${Date.now().toString().slice(-4)}`;
                }

                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rubricas', editingId);
                await setDoc(docRef, constructorData);
                
                showMessage("‚úÖ ¬°Guardado en la nube con √©xito!");
                resetForm(); // Limpiar tras guardar

            } catch (error) {
                console.error(error);
                showMessage(`Error al guardar: ${error.message}`);
            } finally {
                els.saveBtn.innerHTML = '<span>‚òÅÔ∏è Guardar en la Nube</span>';
            }
        });

        // LEER (Realtime Listener)
        function subscribeToRubrics() {
            els.spinner.style.display = 'inline-block';
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'rubricas');
            
            onSnapshot(q, (snapshot) => {
                els.spinner.style.display = 'none';
                els.container.innerHTML = '';

                if (snapshot.empty) {
                    els.container.innerHTML = '<p class="text-gray-500">No hay r√∫bricas guardadas. ¬°Crea una arriba!</p>';
                    return;
                }

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const card = createRubricCard(docSnap.id, data);
                    els.container.appendChild(card);
                });
            }, (error) => {
                console.error("Error suscripci√≥n:", error);
                els.container.innerHTML = `<p class="text-red-500">Error de conexi√≥n: ${error.message}</p>`;
            });
        }

        // UI Tarjeta R√∫brica
        function createRubricCard(id, data) {
            const el = document.createElement('div');
            el.className = 'neubrutalist p-5 bg-white';
            
            // Chips de criterios
            const criteriaChips = Object.keys(data.reportMap || {})
                .filter(k => !data.reportMap[k].isSection)
                .map(k => `<span class="text-xs font-semibold px-2 py-0.5 rounded-full border-2 border-black bg-${data.reportMap[k].color}-200 text-black">${k}</span>`)
                .join(' ');

            el.innerHTML = `
                <div class="flex justify-between items-start">
                    <h3 class="text-2xl font-bold">${data.title}</h3>
                    <span class="text-xs font-mono bg-gray-100 p-1 border border-gray-300 rounded text-gray-500">${id}</span>
                </div>
                <div class="mt-3 mb-4">
                    <h4 class="font-semibold text-sm text-gray-600 mb-1">Criterios:</h4>
                    <div class="flex flex-wrap gap-2">${criteriaChips || '<span class="text-gray-400">Sin criterios</span>'}</div>
                </div>
                <div class="flex gap-2 border-t-2 border-black pt-4">
                    <button class="btn-edit neubrutalist-button bg-yellow-300 hover:bg-yellow-400 flex-1 text-sm">‚úèÔ∏è Editar</button>
                    <button class="btn-delete neubrutalist-button bg-red-300 hover:bg-red-400 flex-1 text-sm">üóëÔ∏è Borrar</button>
                    <button class="btn-json neubrutalist-button bg-gray-200 hover:bg-gray-300 px-3 text-sm" title="Copiar JSON">üìã</button>
                </div>
            `;

            // Eventos Tarjeta
            el.querySelector('.btn-delete').addEventListener('click', async () => {
                // Confirmaci√≥n simple
                if (confirm(`¬øBorrar "${data.title}"?`)) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rubricas', id));
                }
            });

            el.querySelector('.btn-edit').addEventListener('click', () => {
                loadForEditing(id, data);
            });

            el.querySelector('.btn-json').addEventListener('click', () => {
                navigator.clipboard.writeText(JSON.stringify(data, null, 4));
                showMessage("JSON copiado");
            });

            return el;
        }

        // CARGAR EN EDITOR
        function loadForEditing(id, data) {
            resetForm();
            editingId = id;
            constructorData = JSON.parse(JSON.stringify(data)); // Clone deep
            
            // Actualizar UI
            els.title.value = data.title;
            els.editingIndicator.classList.remove('hidden');
            els.saveBtn.innerHTML = '<span>üíæ Actualizar R√∫brica Existente</span>';
            
            // Reconstruir tags
            Object.keys(data.reportMap).forEach(key => {
                const item = data.reportMap[key];
                if(item.isSection) createTag(key, key, els.sList, true);
                else createTag(key, key, els.ceList, false);
            });

            updateOutput();
            // Abrir constructor
            els.constructorContent.style.display = 'block';
            els.toggleBtn.innerText = 'Ocultar ‚ñ≤';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

    </script>
</body>
</html>

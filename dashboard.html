<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Progreso por Criterios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo Neubrutalista */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0;
        }
        .neubrutalist {
            background-color: #ffffff;
            border: 3px solid #000000;
            box-shadow: 6px 6px 0 #000000;
            border-radius: 8px;
        }
        .neubrutalist-button {
            background-color: #ffffff;
            border: 3px solid #000000;
            border-radius: 8px;
            font-weight: 600;
            padding: 10px 16px;
            transition: all 0.2s ease;
            box-shadow: 4px 4px 0 #000000;
        }
        .neubrutalist-button:hover {
            box-shadow: 2px 2px 0 #000000;
            transform: translate(2px, 2px);
        }
        .neubrutalist-button:active {
            box-shadow: 0 0 0 #000000;
            transform: translate(4px, 4px);
        }
        /* Progreso */
        .progress-bar-container {
            border: 2px solid #000;
            border-radius: 6px;
            background-color: #e5e7eb;
            padding: 2px;
        }
        .progress-bar {
            height: 20px;
            border-radius: 4px;
            transition: width 0.3s ease;
            box-shadow: 2px 2px 0 #000 inset;
        }
        /* Modal */
        .modal { 
            display: none; /* Oculto por defecto */
            position: fixed; 
            z-index: 50; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            align-items: center; 
            justify-content: center; 
        }
        /* Estilos para la cabecera fija */
        .header-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Cabecera Fija -->
    <header class="fixed top-0 left-0 right-0 bg-white border-b-2 border-black p-3 z-50 header-shadow flex justify-between items-center">
        <!-- Lado Izquierdo: Navegaci√≥n -->
        <div class="flex gap-2">
            <a href="calif.html" id="repo-link-btn" class="neubrutalist-button bg-blue-300 hover:bg-blue-400 !py-2 !px-3 text-sm sm:text-base">
                &larr; Volver a Herramienta
            </a>
        </div>

        <!-- T√≠tulo Principal (Centro) -->
        <div id="header-main-title" class="flex-grow text-center">
            <h1 class="text-lg sm:text-xl font-bold truncate">Dashboard de Progreso por Criterios</h1>
        </div>

        <!-- Lado Derecho: Espaciador (para mantener centrado el t√≠tulo) -->
        <div class="w-40"> <!-- Ajustar ancho para que coincida con el bot√≥n izquierdo -->
        </div>
    </header>

    <!-- √Årea de entrada -->
    <!-- CORRECCI√ìN: A√±adido mt-24 para dejar espacio al men√∫ fijo -->
    <section class="max-w-4xl mx-auto mb-6 neubrutalist p-5 mt-24">
        <h2 class="text-2xl font-bold border-b-2 border-black pb-2 mb-4">1. A√±adir C√≥digos de Progreso</h2>
        
        <!-- Lista de c√≥digos a√±adidos -->
        <div id="code-list-container" class="mb-4 space-y-2 max-h-48 overflow-y-auto p-2 border border-gray-300 rounded-lg bg-gray-50">
            <p id="code-list-placeholder" class="text-sm text-gray-500 text-center">A√∫n no se han a√±adido c√≥digos.</p>
        </div>

        <!-- Campo para a√±adir nuevo c√≥digo -->
        <div class="flex flex-col sm:flex-row gap-2">
            <input type="text" id="paste-input-single" class="neubrutalist w-full p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg flex-grow" placeholder="Pega un c√≥digo de progreso aqu√≠...">
            <button id="add-code-button" class="neubrutalist-button bg-blue-300 hover:bg-blue-400 !px-5 !py-3">A√±adir</button>
        </div>
        
        <!-- Bot√≥n de procesar -->
        <button id="process-button" class="neubrutalist-button w-full bg-green-300 hover:bg-green-400 mt-4 text-lg">Procesar Evaluaciones</button>
    </section>

    <!-- √Årea de Resultados -->
    <!-- CORRECCI√ìN: A√±adido mt-8 para dejar espacio -->
    <section id="results-area" class="max-w-4xl mx-auto mb-6 mt-8" style="display: none;">
        <h2 id="results-title" class="text-3xl font-bold mb-6 text-center">Informe de Progreso Agregado</h2>
        
        <!-- ===== INICIO DE LA CORRECCI√ìN ===== -->
        <!-- NUEVO: Resumen de Calificaci√≥n -->
        <section id="summary-section" class="neubrutalist p-5 mb-8" style="display: none;">
            <h3 class="text-2xl font-bold border-b-2 border-black pb-2 mb-4">Resumen de Calificaci√≥n</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-center">
                <div>
                    <span class="text-5xl font-bold" id="grade-ponderada">0.0%</span>
                    <p class="text-sm font-semibold text-gray-600">Nota Media Ponderada<br>(Total Puntos / Max Puntos)</p>
                </div>
                <div>
                    <span class="text-5xl font-bold" id="grade-media-criterios">0.0%</span>
                    <p class="text-sm font-semibold text-gray-600">Nota Media de Criterios<br>(Media de % por Criterio)</p>
                </div>
            </div>
        </section>
        <!-- ===== FIN DE LA CORRECCI√ìN ===== -->

        <div id="dashboard-container" class="space-y-6">
            <!-- El informe se generar√° aqu√≠ -->
        </div>
    </section>

    <!-- Modal simple para Alertas -->
    <div id="simple-modal" class="modal" style="display: none;">
        <div id="simple-modal-overlay" class="fixed inset-0 bg-black opacity-60" style="z-index: -1;"></div>
        <div class="neubrutalist p-6 w-full max-w-sm relative bg-white">
            <p id="simple-modal-message" class="text-gray-700 text-center text-lg">Mensaje de alerta.</p>
            <button id="simple-modal-close" class="neubrutalist-button w-full mt-6 bg-blue-300 hover:bg-blue-400">OK</button>
        </div>
    </div>
    
    <!-- Biblioteca de R√∫bricas (para retrocompatibilidad) -->
    <script>
        const RUBRIC_LIBRARY = {
            "rubr_1_0": {
              "title": "1.0 Dec√°logo",
              "reportMap": {
                "s1": {
                  "title": "1. Evaluaci√≥n del Dec√°logo",
                  "color": "blue",
                  "isSection": true
                },
                "CE 4.1": {
                  "title": "CE 4.1: Uso √©tico y etiqueta digital",
                  "color": "purple",
                  "isSection": false
                }
              },
              "evaluationData": [
                {
                  "id": "d1.1",
                  "section": "s1",
                  "title": "1.1 Contenido y Relevancia üéØ",
                  "text": "Valora la pertinencia de las normas (3Ô∏è‚É£: 10 normas claras y pertinentes. 2Ô∏è‚É£: 7-9 normas o poco relevantes. 1Ô∏è‚É£: <7 normas o la mayor√≠a in√∫tiles).",
                  "points": 4.0,
                  "criteria": [
                    "CE 4.1"
                  ]
                },
                {
                  "id": "d1.2",
                  "section": "s1",
                  "title": "1.2 Claridad y Redacci√≥n ‚úçÔ∏è",
                  "text": "Valora la calidad de la redacci√≥n (3Ô∏è‚É£: Impecable, directa y concisa. 2Ô∏è‚É£: Confusa o con varios errores. 1Ô∏è‚É£: Numerosos errores, incomprensible).",
                  "points": 3.0,
                  "criteria": [
                    "CE 4.1"
                  ]
                },
                {
                  "id": "d1.3",
                  "section": "s1",
                  "title": "1.3 Organizaci√≥n y Estructura üß†",
                  "text": "Valora la estructura y presentaci√≥n (3Ô∏è‚É£: Perfecta, numerada y l√≥gica. 2Ô∏è‚É£: Adecuada, orden l√≥gico. 1Ô∏è‚É£: Ca√≥tica, sin orden).",
                  "points": 3.0,
                  "criteria": [
                    "CE 4.1"
                  ]
                }
              ]
            },
            "rubr_1_1": {
              "title": "1.1 Evaluaci√≥n Padlet: Amenazas en la Red",
              "reportMap": {
                "s1": {
                  "title": "1. Evaluaci√≥n de la Publicaci√≥n",
                  "color": "blue",
                  "isSection": true
                },
                "CE3.3": {
                  "title": "CE 3.3: Identificar y reaccionar ante amenazas en la red",
                  "color": "purple",
                  "isSection": false
                },
                "CE2.2": {
                  "title": "CE 2.2: Buscar y seleccionar informaci√≥n con sentido cr√≠tico",
                  "color": "green",
                  "isSection": false
                }
              },
              "evaluationData": [
                {
                  "id": "a1.1",
                  "section": "s1",
                  "title": "1.1 Identificaci√≥n y Precisi√≥n üéØ",
                  "text": "Valora la identificaci√≥n y definici√≥n de la amenaza. (3Ô∏è‚É£: Define con total precisi√≥n qu√© es y c√≥mo act√∫a. 2Ô∏è‚É£: Definici√≥n correcta pero b√°sica o algo confusa. 1Ô∏è‚É£: Definici√≥n incorrecta o no identifica la amenaza).",
                  "points": 3,
                  "criteria": [
                    "CE3.3"
                  ]
                },
                {
                  "id": "a1.2",
                  "section": "s1",
                  "title": "1.2 Medidas de Protecci√≥n üõ°Ô∏è",
                  "text": "Valora la descripci√≥n de las medidas de protecci√≥n. (3Ô∏è‚É£: Describe varias medidas espec√≠ficas (preventivas/correctivas) y explica por qu√© son eficaces. 2Ô∏è‚É£: Describe medidas correctas pero gen√©ricas. 1Ô∏è‚É£: No incluye medidas o no son adecuadas).",
                  "points": 3,
                  "criteria": [
                    "CE3.3"
                  ]
                },
                {
                  "id": "a1.3",
                  "section": "s1",
                  "title": "1.3 Calidad de las Fuentes üìö",
                  "text": "Valora la b√∫squeda y cita de fuentes. (3Ô∏è‚É£: Cita 2 o m√°s fuentes fiables (medios, empresas de seguridad) y las enlaza correctamente. 2Ô∏è‚É£: Cita 1 fuente fiable o de fiabilidad media. 1Ô∏è‚É£: No cita fuentes o usa fuentes de nula fiabilidad).",
                  "points": 2,
                  "criteria": [
                    "CE2.2"
                  ]
                },
                {
                  "id": "a1.4",
                  "section": "s1",
                  "title": "1.4 Claridad y Formato (Padlet) ‚úçÔ∏è",
                  "text": "Valora la calidad y estructura de la publicaci√≥n. (3Ô∏è‚É£: Publicaci√≥n muy clara, bien redactada y visualmente atractiva. 2Ô∏è‚É£: Publicaci√≥n comprensible pero escueta o desorganizada. 1Ô∏è‚É£: Publicaci√≥n incomprensible, desordenada o con graves errores).",
                  "points": 2,
                  "criteria": [
                    "CE2.2"
                  ]
                }
              ]
            },
            "rubr_1_2": {
              "title": "1.2 Infograf√≠a Digital (4¬∫ ESO)",
              "reportMap": {
                "s1": {
                  "title": "1. Evaluaci√≥n de la Infograf√≠a",
                  "color": "blue",
                  "isSection": true
                },
                "CE2.1": {
                  "title": "CE 2.1: Investigaci√≥n y Selecci√≥n",
                  "color": "green",
                  "isSection": false
                },
                "CE4.3": {
                  "title": "CE 4.3: S√≠ntesis y Claridad",
                  "color": "cyan",
                  "isSection": false
                },
                "CE2.2": {
                  "title": "CE 2.2: Dise√±o y Creaci√≥n",
                  "color": "orange",
                  "isSection": false
                },
                "CE4.1": {
                  "title": "CE 4.1: Uso √âtico y Fuentes",
                  "color": "purple",
                  "isSection": false
                }
              },
              "evaluationData": [
                {
                  "id": "i1.1",
                  "section": "s1",
                  "title": "1.1 Investigaci√≥n y Selecci√≥n",
                  "text": "Valora la relevancia y fiabilidad de las fuentes (4pts = Sobresaliente)",
                  "points": 4,
                  "criteria": [
                    "CE2.1"
                  ]
                },
                {
                  "id": "i1.2",
                  "section": "s1",
                  "title": "1.2 S√≠ntesis y Claridad",
                  "text": "Valora la capacidad de s√≠ntesis y la estructura l√≥gica (4pts = Sobresaliente)",
                  "points": 4,
                  "criteria": [
                    "CE4.3"
                  ]
                },
                {
                  "id": "i1.3",
                  "section": "s1",
                  "title": "1.3 Dise√±o y Creaci√≥n",
                  "text": "Valora el dise√±o, equilibrio y uso de elementos (4pts = Sobresaliente)",
                  "points": 4,
                  "criteria": [
                    "CE2.2"
                  ]
                },
                {
                  "id": "i1.4",
                  "section": "s1",
                  "title": "1.4 Uso √âtico y Fuentes",
                  "text": "Valora la correcta citaci√≥n de fuentes y respeto a P.I. (4pts = Sobresaliente)",
                  "points": 4,
                  "criteria": [
                    "CE4.1"
                  ]
                }
              ]
            },
            "rubr_1_3": {
              "title": "1.3 Test de la Academia de Ciberseguridad",
              "reportMap": {
                "s1": {"title": "Caso 1: Email Amazon", "color": "blue", "isSection": true},
                "s2": {"title": "Caso 2: WhatsApp Fiesta", "color": "green", "isSection": true},
                "s3": {"title": "Caso 3: Sorteo Instagram", "color": "yellow", "isSection": true},
                "s4": {"title": "Caso 4: Dilema Copyright", "color": "purple", "isSection": true},
                "s5": {"title": "Caso 5: Netiqueta/Ciberacoso", "color": "teal", "isSection": true},
                "s6": {"title": "Caso 6: Email del Banco", "color": "orange", "isSection": true},
                "CE 3.3": {"title": "CE 3.3: Identificar amenazas", "color": "red", "isSection": false},
                "CE 4.1": {"title": "CE 4.1: Uso √©tico, P.I.", "color": "lime", "isSection": false},
                "CE 4.3": {"title": "CE 4.3: Analizar cr√≠ticamente", "color": "cyan", "isSection": false}
              },
              "evaluationData": [
                {"id": "c1.1", "section": "s1", "title": "1.1. Identifica Phishing (Amazon)", "text": "Identifica el correo como Phishing o amenaza.", "points": 0.5, "criteria": ["CE 3.3", "CE 4.3"]},
                {"id": "c1.2", "section": "s1", "title": "1.2. Banderas Rojas (Amazon)", "text": "Menciona al menos una bandera roja (Ej: URL http://..., dominio .co, saludo gen√©rico, urgencia).", "points": 0.5, "criteria": ["CE 3.3", "CE 4.3"]},
                {"id": "c2.1", "section": "s2", "title": "2.1. Identifica Scam (WhatsApp)", "text": "Identifica el mensaje como Scam/Fraude/Phishing.", "points": 0.5, "criteria": ["CE 3.3", "CE 4.3"]},
                {"id": "c2.2", "section": "s2", "title": "2.2. Banderas Rojas (WhatsApp)", "text": "Menciona al menos una bandera roja (Ej: URL .tk, pide datos personales, desconocido).", "points": 0.5, "criteria": ["CE 3.3", "CE 4.3"]},
                {"id": "c3.1", "section": "s3", "title": "3.1. Identifica Scam (Instagram)", "text": "Identifica la cuenta como Scam/Fraude/Robo de datos.", "points": 0.5, "criteria": ["CE 3.3", "CE 4.3"]},
                {"id": "c3.2", "section": "s3", "title": "3.2. Banderas Rojas (Instagram)", "text": "Menciona al menos una bandera roja (Ej: cuenta nueva, pocos seguidores, link externo).", "points": 0.5, "criteria": ["CE 3.3", "CE 4.3"]},
                {"id": "c4.1", "section": "s4", "title": "4.1. Uso de Contenido (No)", "text": "Responde \"No\" a si se puede usar sin m√°s.", "points": 0.5, "criteria": ["CE 4.1", "CE 4.3"]},
                {"id": "c4.2", "section": "s4", "title": "4.2. Citar Fuente (M√≠nimo)", "text": "Identifica que lo M√çNIMO es citar al autor o la fuente.", "points": 0.5, "criteria": ["CE 4.1", "CE 4.3"]},
                {"id": "c4.3", "section": "s4", "title": "4.3. Licencia (Correcto)", "text": "Explica que lo CORRECTO es buscar la licencia (Ej: Creative Commons) o pedir permiso.", "points": 1.0, "criteria": ["CE 4.1", "CE 4.3"]},
                {"id": "c5.1", "section": "s5", "title": "5.1. Identifica Netiqueta", "text": "Responde \"No\" a si es aceptable (o explica que viola la netiqueta).", "points": 0.5, "criteria": ["CE 4.1", "CE 4.3"]},
                {"id": "c5.2", "section": "s5", "title": "5.2. Propone Acciones", "text": "Propone dos acciones coherentes (Ej: 1. Hablar en privado, 2. Apoyar al compa√±ero, 3. Reportar).", "points": 1.0, "criteria": ["CE 4.1", "CE 4.3"]},
                {"id": "c5.3", "section": "s5", "title": "5.3. Justifica Elecci√≥n", "text": "Justifica brevemente su elecci√≥n de la \"m√°s correcta\".", "points": 0.5, "criteria": ["CE 4.1", "CE 4.3"]},
                {"id": "c6.1", "section": "s6", "title": "6.1. TRES Banderas Rojas (Banco)", "text": "Nombra TRES banderas rojas evidentes (Ej: Dominio .biz, saludo gen√©rico, pide DNI + clave, urgencia).", "points": 1.5, "criteria": ["CE 3.3", "CE 4.3"]},
                {"id": "c6.2", "section": "s6", "title": "6.2. Acci√≥n Correcta (Banco)", "text": "Indica que la √∫nica acci√≥n correcta es Borrarlo / Marcarlo como Spam (y no hacer clic).", "points": 1.5, "criteria": ["CE 3.3", "CE 4.3"]}
              ]
            },
            "rubr_1_4": {
              "title": "1.4 Informe de Ciberdetective (Marimoligram)",
              "reportMap": {
                "s1": {"title": "1. An√°lisis del Perfil", "color": "blue", "isSection": true},
                "s2": {"title": "2. An√°lisis de Interacciones", "color": "green", "isSection": true},
                "s3": {"title": "3. Auditor√≠a de Configuraci√≥n", "color": "yellow", "isSection": true},
                "s4": {"title": "4. Conclusiones y Plan de Acci√≥n", "color": "purple", "isSection": true},
                "CE 1.3": {"title": "CE 1.3: Resolver problemas t√©cnicos", "color": "pink", "isSection": false},
                "CE 3.1": {"title": "CE 3.1: Proteger datos personales", "color": "red", "isSection": false},
                "CE 3.2": {"title": "CE 3.2: Gesti√≥n de seguridad", "color": "indigo", "isSection": false},
                "CE 3.3": {"title": "CE 3.3: Identificar amenazas", "color": "orange", "isSection": false},
                "CE 4.1": {"title": "CE 4.1: Uso √©tico, P.I.", "color": "lime", "isSection": false},
                "CE 4.3": {"title": "CE 4.3: Analizar cr√≠ticamente info", "color": "cyan", "isSection": false},
                "CEsp 4": {"title": "CEsp 4: Ciudadan√≠a digital cr√≠tica", "color": "teal", "isSection": false}
              },
              "evaluationData": [
                {"id": "p1.1", "section": "s1", "title": "1.1. Fuga de Info. Personal", "text": "Valora si el alumno identifica la gravedad de exponer datos sensibles (DNI/Pasaporte) y lo conecta con el riesgo de suplantaci√≥n.", "points": 1.0, "criteria": ["CE 3.1"]},
                {"id": "p1.2", "section": "s1", "title": "1.2. Huella Digital y Seguridad F√≠sica", "text": "Valora si el alumno conecta la informaci√≥n aparentemente inofensiva (gustos, planes de viaje) con riesgos reales (ingenier√≠a social, robo).", "points": 1.0, "criteria": ["CE 3.1"]},
                {"id": "p1.3", "section": "s1", "title": "1.3. Gesti√≥n de Contrase√±as", "text": "Valora si el alumno explica por qu√© el m√©todo es inseguro (predecible, basado en info p√∫blica), no solo si adivina la clave.", "points": 0.5, "criteria": ["CE 3.2"]},
                {"id": "p2.1", "section": "s2", "title": "2.1. Mensajes Directos (Amenazas)", "text": "Valora si el alumno nombra y diferencia correctamente las amenazas (Phishing, Suplantaci√≥n, Extorsi√≥n) y entiende su mecanismo.", "points": 1.5, "criteria": ["CE 3.3"]},
                {"id": "p2.2", "section": "s2", "title": "2.2. Noticias Falsas (Fake News)", "text": "Valora si el alumno aplica un m√©todo de verificaci√≥n (ej. contrastar, @VerdadDigital) y no solo \"sabe\" que es falsa.", "points": 0.5, "criteria": ["CE 4.3"]},
                {"id": "p2.3", "section": "s2", "title": "2.3. Propiedad Intelectual", "text": "Valora si el alumno identifica el conflicto (uso comercial sin permiso) y entiende el concepto de \"derechos de autor\".", "points": 0.5, "criteria": ["CE 4.1"]},
                {"id": "p2.4", "section": "s2", "title": "2.4. Ciberacoso y Etiqueta", "text": "Valora si el alumno identifica los roles (acosador/v√≠ctima) y define el problema (ciberacoso) usando la \"etiqueta digital\".", "points": 0.5, "criteria": ["CE 4.1"]},
                {"id": "p3.1", "section": "s3", "title": "3.1. Actividad de Inicio de Sesi√≥n", "text": "Valora si el alumno identifica el problema t√©cnico (sesi√≥n extra√±a) y propone la soluci√≥n completa (Cerrar sesi√≥n Y cambiar clave).", "points": 1.0, "criteria": ["CE 1.3"]},
                {"id": "p3.2", "section": "s3", "title": "3.2. Contrase√±as Guardadas", "text": "Valora si el alumno identifica el riesgo cr√≠tico de la REUTILIZACI√ìN de contrase√±as (acceso al banco, email, etc.).", "points": 0.5, "criteria": ["CE 3.2"]},
                {"id": "p3.3", "section": "s3", "title": "3.3. T&C y Patrones Oscuros", "text": "Valora si el alumno detecta la intencionalidad del dise√±o (Patr√≥n Oscuro) o las cl√°usulas que vulneran su privacidad.", "points": 0.5, "criteria": ["CE 4.3"]},
                {"id": "p4.1", "section": "s4", "title": "4.1. Resumen de Riesgos", "text": "Valora la capacidad de s√≠ntesis del alumno para enumerar los riesgos y priorizarlos por gravedad (alto/medio/bajo).", "points": 0.5, "criteria": ["CE 3.1", "CE 3.3", "CE 4.3"]},
                {"id": "p4.2", "section": "s4", "title": "4.2. Medidas Correctoras", "text": "Valora si las 5+ medidas propuestas son concretas, eficaces y realistas (ej. 2FA, borrar fotos, bloquear, claves √∫nicas).", "points": 1.0, "criteria": ["CE 3.1", "CE 3.2"]},
                {"id": "p4.3", "section": "s4", "title": "4.3. Reflexi√≥n Final", "text": "Valora si la reflexi√≥n es personal, coherente y conecta la actividad con la importancia de la ciudadan√≠a digital cr√≠tica.", "points": 1.0, "criteria": ["CEsp 4"]}
              ]
            }
        };
    </script>
    <script>
        // --- Elementos del DOM ---
        const pasteInputSingle = document.getElementById('paste-input-single');
        const addCodeButton = document.getElementById('add-code-button');
        const codeListContainer = document.getElementById('code-list-container');
        const codeListPlaceholder = document.getElementById('code-list-placeholder');
        
        const processButton = document.getElementById('process-button');
        const resultsArea = document.getElementById('results-area');
        const resultsTitle = document.getElementById('results-title');
        const dashboardContainer = document.getElementById('dashboard-container');
        // --- INICIO CORRECCI√ìN ---
        const summarySection = document.getElementById('summary-section'); 
        // --- FIN CORRECCI√ìN ---

        // --- Almac√©n de c√≥digos a√±adidos ---
        let addedCodes = []; // Almacena los c√≥digos base64
        let addedStudentNames = new Set(); // Almacena los nombres para validaci√≥n
        let firstStudentName = null; // Almacena el primer nombre a√±adido

        // --- Funciones de Modal Simple ---
        const simpleModal = document.getElementById('simple-modal');
        const simpleModalMessage = document.getElementById('simple-modal-message');
        
        function showSimpleMessage(message, isWarning = false) {
            simpleModalMessage.innerText = message;
            if (isWarning) {
                // (Opcional) Podr√≠amos cambiar el color del modal
            }
            simpleModal.style.display = 'flex';
        }
        
        function hideSimpleMessage() {
            simpleModal.style.display = 'none';
        }
        document.getElementById('simple-modal-close').addEventListener('click', hideSimpleMessage);
        document.getElementById('simple-modal-overlay').addEventListener('click', hideSimpleMessage);

        
        // --- L√≥gica para a√±adir c√≥digos uno a uno ---
        addCodeButton.addEventListener('click', () => {
            const code = pasteInputSingle.value.trim();
            if (!code) {
                showSimpleMessage("Pega un c√≥digo antes de a√±adirlo.");
                return;
            }

            if (addedCodes.includes(code)) {
                showSimpleMessage("Este c√≥digo ya ha sido a√±adido.");
                pasteInputSingle.value = '';
                return;
            }
            
            // --- INICIO DE VALIDACI√ìN Y EXTRACCI√ìN ---
            let selections;
            let taskName;
            let studentName;

            try {
                selections = JSON.parse(atob(code));
                
                // 1. Extraer R√∫brica y Nombre de Tarea
                if (selections.rubricData && selections.rubricData.title) {
                    taskName = selections.rubricData.title;
                } else if (selections.rubricKey || selections.rubricFile) {
                    const key = selections.rubricKey || selections.rubricFile;
                    const rubric = RUBRIC_LIBRARY[key];
                    if (!rubric) throw new Error(`R√∫brica antigua ('${key}') no encontrada.`);
                    taskName = rubric.title || key;
                } else {
                    throw new Error("C√≥digo corrupto (falta r√∫brica).");
                }
                
                // 2. Extraer Nombre de Alumno
                studentName = selections.teamName !== undefined ? selections.teamName : "Sin Nombre";
                if (studentName === "") studentName = "Sin Nombre";

            } catch (error) {
                showSimpleMessage(`Error: El c√≥digo no es v√°lido o est√° corrupto. (${error.message})`);
                return;
            }
            // --- FIN DE VALIDACI√ìN Y EXTRACCI√ìN ---

            // --- INICIO L√ìGICA DE ADVERTENCIA (flexibilidad) ---
            if (addedCodes.length === 0) {
                // Es el primer c√≥digo, establece el nombre base
                firstStudentName = studentName;
            } else {
                // Ya hay c√≥digos. Compara con el *primero* que se a√±adi√≥.
                if (studentName !== firstStudentName) {
                    showSimpleMessage(`Advertencia: Est√°s a√±adiendo un c√≥digo de "${studentName}", pero los primeros c√≥digos eran de "${firstStudentName}". El informe se combinar√°.`, true);
                    // No bloqueamos, solo advertimos
                }
            }
            addedStudentNames.add(studentName); // A√±adir al conjunto de nombres
            // --- FIN L√ìGICA DE ADVERTENCIA ---


            addedCodes.push(code);
            
            if (addedCodes.length === 1) {
                codeListPlaceholder.style.display = 'none';
            }

            // A√±adir el c√≥digo a la lista visual
            const codeEl = document.createElement('div');
            codeEl.className = 'flex justify-between items-center bg-white p-2 border-b';
            codeEl.innerHTML = `
                <div class="flex-grow">
                    <span class="font-semibold text-sm text-gray-800">${taskName}</span>
                    <span class="text-xs text-gray-500 block">(${studentName})</span>
                </div>
                <span class="text-xs text-gray-400 truncate ml-2">...${code.slice(-15)}</span>
            `;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'text-red-500 hover:text-red-700 font-bold px-2 ml-2';
            removeBtn.innerText = '√ó';
            removeBtn.onclick = () => {
                removeCode(code); // Llamar a la funci√≥n de borrado
            };
            
            codeEl.appendChild(removeBtn);
            codeListContainer.appendChild(codeEl);

            pasteInputSingle.value = ''; // Limpiar el campo
        });

        // Modificada para redibujar la lista
        function removeCode(codeToRemove) {
            addedCodes = addedCodes.filter(c => c !== codeToRemove);
            
            // Redibujar toda la lista para recalcular los nombres
            codeListContainer.innerHTML = ''; // Limpiar
            addedStudentNames.clear();
            firstStudentName = null;
            const oldCodes = [...addedCodes]; // Copia temporal
            addedCodes = []; // Resetear
            
            if (oldCodes.length === 0) {
                 codeListPlaceholder.style.display = 'block';
            } else {
                // Volver a a√±adir todos los c√≥digos restantes
                oldCodes.forEach(code => {
                    pasteInputSingle.value = code;
                    addCodeButton.click();
                });
            }
            pasteInputSingle.value = ''; // Limpiar input
        }


        // --- L√≥gica Principal ---
        processButton.addEventListener('click', () => {
            // --- INICIO CORRECCI√ìN ---
            // Ocultar resultados anteriores al empezar
            resultsArea.style.display = 'none';
            summarySection.style.display = 'none';
            dashboardContainer.innerHTML = ''; // Limpiar tarjetas de criterios
            // --- FIN CORRECCI√ìN ---

            const codes = addedCodes;
            if (codes.length === 0) {
                showSimpleMessage("Por favor, a√±ade al menos un c√≥digo de progreso.");
                return;
            }

            let masterReport = {};
            let studentNames = new Set(); // Usar Set para nombres √∫nicos

            try {
                codes.forEach((code, index) => {
                    const selections = JSON.parse(atob(code));
                    
                    const currentName = (selections.teamName !== undefined && selections.teamName !== "") ? selections.teamName : "Sin Nombre";
                    studentNames.add(currentName); // A√±adir al Set

                    let rubric;
                    let taskName;
                    
                    if (selections.rubricData && selections.rubricData.title) {
                        rubric = selections.rubricData;
                        taskName = rubric.title;
                    } else if (selections.rubricKey || selections.rubricFile) {
                        const key = selections.rubricKey || selections.rubricFile;
                        rubric = RUBRIC_LIBRARY[key];
                        if (!rubric) throw new Error(`R√∫brica antigua ('${key}') no encontrada.`);
                        taskName = rubric.title || key;
                    } else {
                        throw new Error(`C√≥digo corrupto.`);
                    }

                    let taskCEData = {};
                    rubric.evaluationData.forEach(item => {
                        const radioValue = parseFloat(selections.radios[item.id] || 0);
                        // Comprobar extras (retrocompatibilidad)
                        const extrasCount = selections.extras ? (selections.extras[item.id] || 0) : 0;
                        const extraValue = extrasCount * 0.10;
                        const totalValue = radioValue + extraValue;

                        const scoredPoints = totalValue * item.points;
                        const maxPoints = item.points;

                        item.criteria.forEach(ce => {
                            ce = ce.trim();
                            if (!taskCEData[ce]) {
                                taskCEData[ce] = { score: 0, max: 0 };
                            }
                            taskCEData[ce].score += scoredPoints;
                            taskCEData[ce].max += maxPoints;
                        });
                    });

                    Object.keys(taskCEData).forEach(ce => {
                        const ceData = taskCEData[ce];
                        if (ceData.max === 0) return;

                        const ceInfo = rubric.reportMap[ce];

                        if (!masterReport[ce]) {
                            masterReport[ce] = {
                                title: ceInfo?.title || ce,
                                color: ceInfo?.color || 'gray',
                                tasks: [],
                                totalScore: 0,
                                totalMax: 0,
                                bestTaskName: '',
                                bestTaskPerc: -1
                            };
                        }

                        masterReport[ce].tasks.push({
                            taskName: taskName,
                            score: ceData.score,
                            max: ceData.max
                        });

                        masterReport[ce].totalScore += ceData.score;
                        masterReport[ce].totalMax += ceData.max;

                        const taskPerc = (ceData.max > 0) ? (ceData.score / ceData.max) * 100 : 0;
                        // Correcci√≥n: solo actualizar si es MEJOR
                        if (taskPerc > masterReport[ce].bestTaskPerc) {
                            masterReport[ce].bestTaskPerc = taskPerc;
                            masterReport[ce].bestTaskName = taskName;
                        }
                    });
                });

                // 4. Mostrar el Dashboard
                const finalStudentName = Array.from(studentNames).join(', ');
                displayDashboard(masterReport, finalStudentName);

            } catch (error) {
                console.error("Error al procesar los c√≥digos:", error);
                showSimpleMessage("Error al procesar los c√≥digos: " + error.message);
                resultsArea.style.display = 'none';
            }
        });

        // --- INICIO CORRECCI√ìN ---
        // Nueva funci√≥n para calcular y mostrar el resumen
        function calculateAndDisplaySummary(masterReport) {
            let totalScore = 0;
            let totalMax = 0;
            let sumOfPercentages = 0;
            let criteriaCount = 0;

            for (const ce in masterReport) {
                const ceData = masterReport[ce];
                
                // Para Media Ponderada
                totalScore += ceData.totalScore;
                totalMax += ceData.totalMax;
                
                // Para Media de Criterios
                const cePerc = (ceData.totalMax > 0) ? (ceData.totalScore / ceData.totalMax) * 100 : 0;
                sumOfPercentages += cePerc;
                criteriaCount++;
            }

            const ponderadaPerc = (totalMax > 0) ? (totalScore / totalMax) * 100 : 0;
            const mediaPerc = (criteriaCount > 0) ? (sumOfPercentages / criteriaCount) : 0;

            document.getElementById('grade-ponderada').innerText = ponderadaPerc.toFixed(1) + '%';
            document.getElementById('grade-media-criterios').innerText = mediaPerc.toFixed(1) + '%';
            summarySection.style.display = 'block'; // Mostrar el resumen
        }
        // --- FIN CORRECCI√ìN ---

        function displayDashboard(masterReport, studentName) {
            dashboardContainer.innerHTML = ''; // Limpiar tarjetas
            resultsTitle.innerText = `Informe de Progreso Agregado: ${studentName}`;
            
            const sortedCEKeys = Object.keys(masterReport).sort();

            if (sortedCEKeys.length === 0) {
                showSimpleMessage("No se encontraron datos de criterios evaluables en los c√≥digos proporcionados.");
                resultsArea.style.display = 'none';
                summarySection.style.display = 'none'; // Ocultar resumen si no hay datos
                return;
            }

            // --- INICIO CORRECCI√ìN ---
            // Calcular y mostrar el resumen ANTES de mostrar los resultados
            calculateAndDisplaySummary(masterReport);
            // --- FIN CORRECCI√ìN ---

            sortedCEKeys.forEach(ce => {
                const ceData = masterReport[ce];
                const totalPerc = (ceData.totalMax > 0) ? (ceData.totalScore / ceData.totalMax) * 100 : 0;
                const color = ceData.color || 'gray';

                const ceCard = document.createElement('div');
                ceCard.className = 'neubrutalist overflow-hidden';

                let headerHTML = `
                    <div class="p-4 border-b-2 border-black bg-${color}-100">
                        <h3 class="text-2xl font-bold text-black">${ceData.title} (${ce})</h3>
                        
                        <div class="flex justify-between items-center my-2">
                            <span class="font-semibold text-sm">Progreso Total (Agregado)</span>
                            <span class="font-bold text-sm">
                                ${ceData.totalScore.toFixed(2)} / ${ceData.totalMax.toFixed(2)}
                            </span>
                        </div>
                        <div class="progress-bar-container w-full">
                            <div class="progress-bar bg-${color}-500" style="width: ${totalPerc}%;"></div>
                        </div>

                        <div class="mt-3 text-sm">
                            <span class="font-semibold">Mejor rendimiento:</span>
                            <span class="font-bold text-green-700">${ceData.bestTaskName}</span>
                            (${ceData.bestTaskPerc.toFixed(0)}%)
                        </div>
                    </div>
                `;

                let tasksHTML = '<ul class="divide-y divide-gray-200 bg-white">';
                
                ceData.tasks.forEach(task => {
                    const perc = (task.max > 0) ? (task.score / task.max) * 100 : 0;
                    
                    let statusHTML = '';
                    if (perc >= 80) {
                        statusHTML = `<span class="font-bold text-green-600">Superado</span>`;
                    } else if (perc >= 50) {
                        statusHTML = `<span class="font-bold text-orange-600">En Progreso</span>`;
                    } else {
                        statusHTML = `<span class="font-bold text-red-600">No Superado</span>`;
                    }
                    
                    let bestMark = '';
                    // Correcci√≥n: Comprobar tambi√©n el porcentaje por si hay empates
                    if (task.taskName === ceData.bestTaskName && perc === ceData.bestTaskPerc) {
                        bestMark = `<span class="text-xs font-bold text-white bg-green-500 px-2 py-0.5 rounded-full ml-2">MEJOR</span>`;
                    }

                    tasksHTML += `
                        <li class="p-3 flex justify-between items-center">
                            <div>
                                <span class="font-semibold">${task.taskName}</span> ${bestMark}
                                <div class="text-sm text-gray-600">
                                    Puntuaci√≥n: ${task.score.toFixed(2)} / ${task.max.toFixed(2)} (${perc.toFixed(0)}%)
                                </div>
                            </div>
                            <div class="text-right text-sm">
                                ${statusHTML}
                            </div>
                        </li>
                    `;
                });

                tasksHTML += '</ul>';
                
                ceCard.innerHTML = headerHTML + tasksHTML;
                dashboardContainer.appendChild(ceCard);
            });

            resultsArea.style.display = 'block'; // Mostrar todo el bloque de resultados
        }

    </script>
</body>
</html>
